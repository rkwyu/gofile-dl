name: Nightly Regression

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 2 * * *" # Runs at 02:00 UTC every day

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: [3.11]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Create test file
      run: |
        mkdir -p testdata
        echo "hello gofile" > testdata/test.txt

    - name: Upload file to Gofile
      id: upload
      run: |
        SERVER=$(curl -s https://api.gofile.io/servers | jq -r '.data.servers[0].name')
        RESPONSE=$(curl -s -F "file=@testdata/test.txt" "https://${SERVER}.gofile.io/uploadFile")
        echo "$RESPONSE"
        LINK=$(echo "$RESPONSE" | jq -r '.data.downloadPage')
        echo "GOFILE_LINK=$LINK" >> $GITHUB_ENV

    - name: Clean output folder
      run: rm -f ./output/*

    - name: Run gofile-dl
      run: |
        echo "Testing download from $GOFILE_LINK"
        python run.py "$GOFILE_LINK"

    - name: Verify
      run: |
        FILE="./output/test.txt"
        if [ ! -f "$FILE" ]; then
          echo "Download failed: file missing"
          exit 1
        fi
        if ! grep -q "hello gofile" "$FILE"; then
          echo "Download failed: content mismatch"
          exit 1
        fi
        echo "Download OK"
